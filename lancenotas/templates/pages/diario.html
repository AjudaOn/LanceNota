{% extends "layouts/app.html" %}

{% block title %}Diário — {{ turma.nome }} — LanceNotas{% endblock %}

{% block content %}
  <div class="mb-6">
    <a
      href="{{ url_for('pages.turma_detail', turma_id=turma.id) }}"
      class="inline-flex items-center gap-2 mb-4 px-3 py-2 rounded-lg border border-gray-300 hover:bg-gray-50 text-sm"
    >
      ← Voltar para turma
    </a>
    <h1 class="text-3xl font-bold text-gray-900">Diário da Turma</h1>
    <p class="text-gray-600 mt-2">{{ turma.nome }} — Anotações diárias</p>
  </div>

  <div class="mb-6">
    <div class="inline-flex items-center rounded-lg border border-gray-200 bg-white p-1">
      <a
        href="{{ url_for('pages.turma_detail', turma_id=turma.id, tab='detalhes') }}"
        class="px-4 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50"
      >
        Detalhes da Turma
      </a>
      <a
        href="{{ url_for('pages.turma_detail', turma_id=turma.id, tab='atividades') }}"
        class="px-4 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50"
      >
        Atividades
      </a>
      <a
        href="{{ url_for('pages.turma_diario', turma_id=turma.id) }}"
        class="px-4 py-2 rounded-md text-sm font-medium bg-blue-600 text-white"
      >
        Diário
      </a>
    </div>
  </div>

  {# Anotação de hoje (1 por dia) #}
  <div class="bg-white border border-gray-200 rounded-xl p-4 mb-8">
    <div class="flex items-start justify-between gap-3 mb-4">
      <div>
        <h2 class="text-lg font-semibold text-gray-900">Anotação de hoje</h2>
        <p class="text-sm text-gray-600">{{ hoje.strftime('%d/%m/%Y') }}</p>
      </div>
      {% if anotacao_hoje %}
        <form
          method="post"
          action="{{ url_for('pages.turma_diario_excluir', turma_id=turma.id, anotacao_id=anotacao_hoje.id) }}"
          class="inline"
          onsubmit="return confirm('Tem certeza que deseja excluir a anotação de hoje?')"
        >
          <button
            type="submit"
            class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-gray-200 text-red-700 hover:bg-red-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-red-500 text-sm"
          >
            Excluir
          </button>
        </form>
      {% endif %}
    </div>

    <form method="post" action="{{ url_for('pages.turma_diario_salvar', turma_id=turma.id) }}">
      <input type="hidden" name="data" value="{{ hoje.isoformat() }}" />
      {% if anotacao_hoje %}
        <input type="hidden" name="anotacao_id" value="{{ anotacao_hoje.id }}" />
      {% endif %}

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1" for="diario-hoje-titulo">Título (opcional)</label>
        <input
          id="diario-hoje-titulo"
          type="text"
          name="titulo"
          placeholder="Ex: Artes — revisão, Projeto — avaliação…"
          value="{{ anotacao_hoje.titulo if anotacao_hoje and anotacao_hoje.titulo else '' }}"
          class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
      </div>

      <label class="block text-sm font-medium text-gray-700 mb-1" for="diario-hoje-texto">Anotação</label>
      <textarea
        id="diario-hoje-texto"
        name="anotacao"
        rows="6"
        class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 mb-3"
        placeholder="Escreva aqui o que foi feito na aula, observações importantes…"
        required
      >{{ anotacao_hoje.anotacao if anotacao_hoje else '' }}</textarea>

      <div class="flex items-center justify-between gap-3">
        <div class="text-xs text-gray-500">
          {% if anotacao_hoje %}
            Salvo {{ anotacao_hoje.updated_at.strftime('%d/%m/%Y às %H:%M') }}
          {% else %}
            Ainda não há anotação salva para hoje.
          {% endif %}
        </div>
        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg px-5 py-2">
          Salvar
        </button>
      </div>
    </form>
  </div>

  {# Calendário + Dia selecionado #}
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="bg-white border border-gray-200 rounded-xl p-4">
      <div class="flex items-center justify-between gap-3 mb-4">
        <div>
          <h2 class="text-lg font-semibold text-gray-900">Calendário</h2>
          <p class="text-sm text-gray-600">{{ mes_label }} — {{ contagens_mes|length }} dia{{ 's' if contagens_mes|length != 1 else '' }} com anotação</p>
        </div>
        <div class="flex items-center gap-2">
          <a
            href="{{ url_for('pages.turma_diario', turma_id=turma.id, mes=prev_mes_str, dia=prev_dia_str) }}"
            class="inline-flex items-center justify-center w-9 h-9 rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500"
            aria-label="Mês anterior"
            title="Mês anterior"
          >
            ‹
          </a>
          <a
            href="{{ url_for('pages.turma_diario', turma_id=turma.id, mes=next_mes_str, dia=next_dia_str) }}"
            class="inline-flex items-center justify-center w-9 h-9 rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500"
            aria-label="Próximo mês"
            title="Próximo mês"
          >
            ›
          </a>
        </div>
      </div>

      <div class="grid grid-cols-7 gap-1 text-xs text-gray-500 mb-2">
        {% for label in weekday_labels %}
          <div class="text-center py-1 font-medium">{{ label }}</div>
        {% endfor %}
      </div>

      <div class="grid grid-cols-7 gap-1">
        {% for week in cal_weeks %}
          {% for day in week %}
            {% set in_month = (day.month == mes_numero and day.year == mes_ano) %}
            {% set is_today = (day == hoje) %}
            {% set is_selected = (day == dia_selecionado) %}
            {% set has_notes = (contagens_mes.get(day) if in_month else 0) %}

            <a
              href="{{ url_for('pages.turma_diario', turma_id=turma.id, mes=day.strftime('%Y-%m'), dia=day.isoformat()) }}"
              class="relative h-10 rounded-lg border text-sm flex items-center justify-center
                {% if in_month %}border-gray-200 text-gray-900 hover:bg-gray-50{% else %}border-transparent text-gray-400 hover:bg-gray-50{% endif %}
                {% if is_selected %}bg-blue-600 text-white border-blue-600 hover:bg-blue-700{% endif %}
                {% if is_today and not is_selected %}ring-1 ring-blue-200{% endif %}
                focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500"
              aria-label="Selecionar dia {{ day.strftime('%d/%m/%Y') }}"
            >
              {{ day.day }}
              {% if has_notes and not is_selected %}
                <span class="absolute bottom-1 left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-blue-600"></span>
              {% elif has_notes and is_selected %}
                <span class="absolute bottom-1 left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-white/90"></span>
              {% endif %}
            </a>
          {% endfor %}
        {% endfor %}
      </div>

      <div class="mt-4 text-sm text-gray-600">
        <div class="flex items-center gap-2">
          <span class="inline-block w-3 h-3 rounded bg-blue-600"></span>
          <span>Dia selecionado</span>
        </div>
        <div class="flex items-center gap-2 mt-1">
          <span class="inline-block w-3 h-3 rounded ring-1 ring-blue-200 bg-white"></span>
          <span>Hoje</span>
        </div>
        <div class="flex items-center gap-2 mt-1">
          <span class="inline-block w-3 h-3 rounded-full bg-blue-600"></span>
          <span>Dia com anotação</span>
        </div>
      </div>
    </div>

    <div class="lg:col-span-2 bg-white border border-gray-200 rounded-xl p-4">
      <div class="flex items-start justify-between gap-3 mb-4">
        <div>
          <h2 class="text-lg font-semibold text-gray-900">Dia selecionado</h2>
          <p class="text-sm text-gray-600">
            {{ dia_selecionado.strftime('%d/%m/%Y') }} — {{ anotacoes_dia_selecionado|length }} {{ 'anotação' if anotacoes_dia_selecionado|length == 1 else 'anotações' }}
          </p>
        </div>
        {% if dia_selecionado != hoje %}
          <div class="text-xs text-gray-500 mt-1">
            Para criar uma nova anotação, use “Anotações de hoje”.
          </div>
        {% endif %}
      </div>

      {% if dia_selecionado == hoje %}
        <div class="text-sm text-gray-600">
          Dia selecionado é hoje. Veja as anotações no topo da página.
        </div>
      {% elif anotacoes_dia_selecionado %}
        <div class="space-y-3">
          {% for anotacao in anotacoes_dia_selecionado %}
            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50" id="anotacao-{{ anotacao.id }}">
              <div class="flex items-start justify-between mb-2">
                <div class="flex items-center gap-2">
                  <span class="text-sm font-medium text-blue-600">{{ anotacao.created_at.strftime('%H:%M') }}</span>
                  {% if anotacao.titulo %}
                    <span class="text-sm font-semibold text-gray-900">— {{ anotacao.titulo }}</span>
                  {% endif %}
                </div>
                <div class="flex items-center gap-1">
                  <button
                    type="button"
                    onclick='openEditModal({{ anotacao.id }}, "{{ anotacao.data.isoformat() }}", {{ anotacao.titulo | tojson if anotacao.titulo else "null" }}, {{ anotacao.anotacao | tojson }})'
                    class="p-1.5 text-blue-600 hover:bg-blue-100 rounded-lg transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500"
                    aria-label="Editar anotação"
                    title="Editar"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                    </svg>
                  </button>
                  <form
                    method="post"
                    action="{{ url_for('pages.turma_diario_excluir', turma_id=turma.id, anotacao_id=anotacao.id) }}"
                    class="inline"
                    onsubmit="return confirm('Tem certeza que deseja excluir esta anotação?')"
                  >
                    <button
                      type="submit"
                      class="p-1.5 text-red-600 hover:bg-red-100 rounded-lg transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-red-500"
                      aria-label="Excluir anotação"
                      title="Excluir"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                      </svg>
                    </button>
                  </form>
                </div>
              </div>
              <div class="text-gray-700 whitespace-pre-wrap">{{ anotacao.anotacao }}</div>
              {% if anotacao.updated_at != anotacao.created_at %}
                <div class="text-xs text-gray-500 mt-2">Editado {{ anotacao.updated_at.strftime('%d/%m/%Y às %H:%M') }}</div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-center py-10 text-gray-500 border-2 border-dashed border-gray-200 rounded-lg">
          <p>Nenhuma anotação nesse dia.</p>
          <p class="text-sm mt-1">Use o calendário para navegar por outras datas.</p>
        </div>
      {% endif %}
    </div>
  </div>

  {# Modal Edição #}
  <div id="edit-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50" onclick="closeEditModal()"></div>
    <div class="relative h-full flex items-center justify-center p-4">
      <div class="w-full max-w-2xl bg-white rounded-xl shadow-xl border border-gray-200">
        <div class="p-6 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">Editar Anotação</h2>
          <p class="text-sm text-gray-500 mt-1" id="edit-modal-data"></p>
        </div>

        <form method="post" action="{{ url_for('pages.turma_diario_salvar', turma_id=turma.id) }}" class="p-6">
          <input type="hidden" name="data" id="edit-modal-data-input" />
          <input type="hidden" name="anotacao_id" id="edit-modal-id" />
          
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Título (opcional)</label>
            <input
              type="text"
              name="titulo"
              id="edit-modal-titulo"
              placeholder="Ex: 1ª aula - Artes, 2ª aula - Projeto"
              class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <textarea
            name="anotacao"
            id="edit-modal-textarea"
            rows="6"
            class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4"
            placeholder="Edite sua anotação..."
            required
          ></textarea>

          <div class="flex items-center justify-end gap-2">
            <button
              type="button"
              onclick="closeEditModal()"
              class="border border-gray-300 rounded-lg px-4 py-2 hover:bg-gray-50"
            >
              Cancelar
            </button>
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg px-5 py-2">
              Salvar alterações
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    function openEditModal(id, data, titulo, texto) {
      document.getElementById('edit-modal-data').textContent = 'Data: ' + formatDate(data);
      document.getElementById('edit-modal-data-input').value = data;
      document.getElementById('edit-modal-id').value = id;
      document.getElementById('edit-modal-titulo').value = titulo || '';
      document.getElementById('edit-modal-textarea').value = texto;
      document.getElementById('edit-modal').classList.remove('hidden');
    }

    function closeEditModal() {
      document.getElementById('edit-modal').classList.add('hidden');
    }

    function formatDate(dateStr) {
      const parts = dateStr.split('-');
      return parts[2] + '/' + parts[1] + '/' + parts[0];
    }

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeEditModal();
      }
    });
  </script>
{% endblock %}
